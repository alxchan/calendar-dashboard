@using CalendarDashboard.Models
@using Google.Apis.Calendar.v3.Data
@using System.Text.Json
@inject ApiClientService apiClientService

@{
    var today = DateTime.Today;
    // Find the Sunday of the current week (assuming Sunday start)
    var sunday = today.AddDays(-(int)today.DayOfWeek);

    var days = Enumerable.Range(0, 7)
    .Select(i => sunday.AddDays(i))
    .ToList();
}

@if (isLoading)
{
    <p class="text-primary-text">Loading...</p>
}
else
{
    <div class="grid lg:grid-cols-7 md:grid-cols-3 sm:grid-cols-1 [&>*]:text-primary-text gap-1 [&>*]:text-center h-full w-full box-border overflow-y-auto">
        @* Needs to contain: Event name, Time *@
        @for (int i = 0; i < 7; i++)
        {
            var day = days[i];
            var dayEvents = calendarEvents!.Where(e => DateTime.Parse(e.StartTime.DateTimeRaw).Date == day.Date).ToList();

            <div class="gap-1 flex flex-col cursor-default select-none">
                <div class="bg-secondary-background flex min:h-fit justify-center items-center py-2 flex-col">
                    <div class="font-semibold">@day.ToString("dddd")</div>
                    <div class="font-semibold">@day.Day</div>
                </div>
                @foreach (var evt in dayEvents)
                    {
                        <div class="bg-secondary-background cursor-default min:h-fit py-3 flex justify-center items-center flex-col truncate max-w-full">
                            <div class="font-medium truncate max-w-[90vw] text-secondary-text">@evt.Name</div>
                            <div class="text-sm text-secondary-text">@DateTime.Parse(evt.StartTime.DateTimeRaw).ToString("h:mm tt") - @DateTime.Parse(evt.EndTime.DateTimeRaw).ToString("h:mm tt")</div>
                        </div>
                    }
                <div class="md:flex hidden bg-background opacity-0 cursor-pointer hover:opacity-50 justify-center items-center flex-col py-5">Add</div>
            </div>
        }
    <div class="md:hidden absolute col-span-1 mt-4 text-center flex flex-row-reverse right-5 bottom-26">
        <button class="bg-background text-secondary-text px-6 py-3 rounded-full shadow-lg hover:brightness-150 cursor-pointer select-none">
        +
        </button>
    </div>
    </div>
}
@code {
    private string? data;
    private bool isLoading = true;
    private List<LocalEvent> calendarEvents;

    protected override async System.Threading.Tasks.Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {

            try
            {
                calendarEvents = await apiClientService.CallApiAsync("/api/calendar/test");
                // calendarEvents = JsonSerializer.Deserialize<List<LocalEvent>>(data!)!;
            }
            catch (HttpRequestException ex)
            {
                Console.WriteLine($"Error fetching data: {ex.Message}");
                data = null;
            }
            finally
            {
                isLoading = false;
                StateHasChanged();
            }
        }
    }
}